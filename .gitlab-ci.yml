deploy:
  stage: deploy
  image: node:current-alpine
  script:
    - |
      set -euo pipefail
      apk add --no-cache rsync
      npm i -g wrangler

      # dist 作成 + _headers
      rm -rf dist
      mkdir -p dist

      rsync -a --delete \
        --exclude '.git*' \
        --exclude 'dist' \
        --exclude 'src' \
        --exclude 'AGENTS.md' \
        --exclude 'maketoc' \
        --exclude 'README.md' \
        --exclude 'wrangler.toml' \
        --exclude '.gitlab-ci.yml' \
        --exclude 'package-lock.json' \
        ./ dist/

      cat > dist/_headers <<'EOF'
      /*
        Cache-Control: public, max-age=180, stale-while-revalidate=86400
      EOF

      # デプロイ（workers.dev の場合）
      wrangler deploy

      # 独自ドメインを使う場合は以下に切り替え:
      # wrangler deploy --env prod
  only:
    - master

pages:
  stage: deploy
  image: alpine:latest
  script:
    - apk update
    - apk upgrade
    - apk add brotli
    - mkdir .public
    - cp -r * .public
    - cp -r .well-known .public
    - mv .public public
    - find public -type f -regex '.*\.\(htm\|html\|txt\|text\|js\|css\|asc\)$' -exec gzip -f -k {} \; 
    - find public -type f -regex '.*\.\(htm\|html\|txt\|text\|js\|css\|asc\)$' -exec brotli -f -k {} \;

  artifacts:
    paths:
      - public
  only:
    - master
