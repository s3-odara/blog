<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8" /><title>
Linuxでロック中に新規挿入されたUSBを使えないようにする —  s3-odaraのブログ
</title><meta name="description" content="LinuxのデバイスAuthorize機能を使用してロック中などの状態に応じてUSBデバイスの使用可否を変える方法。" /><meta name="viewport" content="initial-scale=1" /><link rel="canonical" href="https://www.s3-odara.net/article/linux-usb-authorize.html" /><link rel="stylesheet" type="text/css" href="../css/default.css" /><link rel="stylesheet" type="text/css" href="../css/prism.css" /><script defer="defer" src="../js/bash_shell_diff.js"></script></head><body>

<header>
<nav class="blog">
<a href="../index.html">Home</a>
<a rel="author" href="../about.html">About Me</a>
<a rel="alternate" href="https://blog.omae.dev/">Mirror</a>
</nav>
</header>

<main class="blog">
<article>
<header>
<h1>
Linuxでロック中に新規挿入されたUSBを使えないようにする
</h1>
<time datetime="2026-02-11">
2026-02-11
</time>

<nav id="toc">
<!--begin-toc-->
<ul class="toc">
<li><a href="#usb-">
認可するUSBを制限する意義
</a></li>
<li><a href="#x">方法</a></li>
<li><a href="#usbguard">USBGuardを使えば良くない？</a></li>
<li><a href="#x0">参考になるサイト</a></li>
</ul>
<!--end-toc-->
</nav>
</header>

<h2 id="usb-">
認可するUSBを制限する意義
</h2>

<p>
BadUSBというものがある。多くはUSB HIDキーボードとして動作して、任意のキー入力をしたり、USB Ethernetとして動作して通信経路を曲げて攻撃を行うもので、脆弱性というよりそれがUSBの機能である。
</p>

<p>
そもそも物理アクセスされている時点で他にいくらでも攻撃手段があるが、Linuxの機能を使うことでUSBデバイスの認可を制限することができる。
</p>

<dl><dt>できること</dt><dd>出来心でBadUSBを挿入してくる隣人を遠ざけられる。</dd><dt>できないこと</dt><dd>DMAの脆弱性を突いたり、別の物理的攻撃をしてくる隣人に対する防護。</dd><dd>USBポートの物理破壊。</dd></dl>

<h2 id="x">方法</h2>

<p>
LinuxでUSBデバイスを制限する方法としては、カーネルモジュールのアンロードやカーネルパラメータの設定をするという手もあるが、通常のデスクトップ環境で柔軟に管理するためには、sysfsから制御する方法がいいと思う。
</p>

<p>
私は次のようなスクリプトを<code>~/.local/bin/</code>に置いてriverでロックするためのショートカットに割り当てている。
</p>

<pre><code class="language-shell">#!/bin/sh
set -eu

doas /usr/local/bin/usb-authorize-default.sh lock

waylock -ignore-empty-password &amp;
lock_pid=$!

sleep 1

doas /usr/local/bin/suspend-then-hibernate.sh

# 復帰後、ロック解除されたらusb unlock
wait "$lock_pid"
doas /usr/local/bin/usb-authorize-default.sh unlock
makoctl reload</code></pre>

<p>
スクリプトの中で呼びだしている<code>usb-authorize-default.sh</code>は以下である。
</p>

<pre><code class="language-shell">#!/usr/bin/env bash
set -euo pipefail

mode="${1:-}"
case "$mode" in
  lock)   val=2 ;;  # internal-only
  unlock) val=1 ;;  # allow-all (default)
  *) echo "Usage: $0 {lock|unlock}" &lt;&amp;2; exit 2 ;;
esac

for host in /sys/bus/usb/devices/usb*; do
  if [[ -w "$host/authorized_default" ]]; then
    printf '%s' "$val" &gt; "$host/authorized_default"
  fi
done</code></pre>

<p>
<a href="https://docs.kernel.org/usb/authorization.html">Linuxのデバイスをロックする機能</a>を使用して、ロック中には新規に挿入されたUSBを許可しない設定に変えている。
</p>

<p>
1が通常デフォルトで、全てのUSBデバイスを認可し、2にすると内蔵USBポートのみを認可する。
既に接続されているUSBデバイスは、2にしても認可を解除されることはない。
</p>

<h2 id="usbguard">USBGuardを使えば良くない？</h2>

<p>
はい。<a href="https://github.com/USBGuard/usbguard">優秀なフロントと優れた権限処理機構を備えたBadUSBに対応するためのLinux向けソフトウェア</a>が存在しているので、普通はそちらを使おう。
私が不出来なスクリプトを使うのはUsbGuardの導入にelogindかsystemd-logindの依存が必要で、私のデスクトップ環境にはそれらがないからである。
</p>

<h2 id="x0">参考になるサイト</h2>

<!--begin-ref-->
<ul><li><a href="https://docs.kernel.org/usb/authorization.html">Authorizing (or not) your USB devices to connect to the system — The Linux Kernel documentation</a></li><li><a href="https://github.com/usbguard/usbguard">GitHub - USBGuard/usbguard: USBGuard is a software framework for implementing USB device authorization policies (what kind of USB devices are authorized) as well as method of use policies (how a USB device may interact with the system)</a></li><li><a href="https://wiki.archlinux.jp/index.php/usbguard">USBGuard - ArchWiki</a></li><li><a href="https://docs.kernel.org/admin-guide/kernel-parameters.html">The kernel’s command-line parameters — The Linux Kernel documentation</a></li></ul>
<!--end-ref-->
</article>
</main>

<footer>
<a href="../index.html">s3-odaraのサイト</a> by <a rel="author" href="../about.html">小原晴太</a> is Licensed under <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>
<nav><a href="../index.html">HOME</a></nav>
</footer>
</body></html>
